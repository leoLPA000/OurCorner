<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Reproductor</title>
    <link rel="stylesheet" href="../assets/css/estilos.css">
    <style>
        body {
            font-family: sans-serif;
            margin: 12px;
        }

        .player-root {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .player-info {
            flex: 1
        }

        .player-controls {
            display: flex;
            gap: 8px;
            align-items: center
        }
    </style>
</head>

<body>
    <div class="player-root">
        <div class="player-info">
            <div class="cancion-titulo">—</div>
            <div class="cancion-artista">—</div>
        </div>

        <div class="player-controls">
            <button id="btnPrev">⏮️</button>
            <button id="btnPlay">▶️</button>
            <button id="btnNext">⏭️</button>
            <input id="vol" type="range" min="0" max="100" value="30">
        </div>
    </div>

    <audio id="audioEl" crossorigin="anonymous"></audio>

    <script>
        // Popup player: recibe mensajes del opener y envía updates
        const audio = document.getElementById('audioEl');
        const btnPlay = document.getElementById('btnPlay');
        const btnPrev = document.getElementById('btnPrev');
        const btnNext = document.getElementById('btnNext');
        const vol = document.getElementById('vol');
        const tituloEl = document.querySelector('.cancion-titulo');
        const artistaEl = document.querySelector('.cancion-artista');

        let playlist = [];
        let current = 0;

        function sendState() {
            const msg = { type: 'popup-state', playing: !audio.paused && !audio.ended, currentTrack: current, volume: audio.volume };
            if (window.opener && !window.opener.closed) window.opener.postMessage(msg, '*');
        }

        function loadTrack(index) {
            if (!playlist[index]) return;
            current = index;
            audio.src = playlist[current].src;
            tituloEl.textContent = playlist[current].titulo || '—';
            artistaEl.textContent = playlist[current].artista || '—';
            audio.load();
        }

        window.addEventListener('message', (ev) => {
            const data = ev.data || {};
            if (data && data.type === 'init-player') {
                playlist = data.playlist || [];
                current = data.currentTrack || 0;
                audio.volume = data.volume || 0.3;
                loadTrack(current);
                if (data.playing) {
                    audio.play().catch(() => { });
                }
                sendState();
            }

            if (data && data.type === 'control') {
                const cmd = data.cmd;
                if (cmd === 'play') audio.play().catch(() => { });
                if (cmd === 'pause') audio.pause();
                if (cmd === 'next') { loadTrack((current + 1) % playlist.length); audio.play().catch(() => { }); }
                if (cmd === 'prev') { loadTrack((current - 1 + playlist.length) % playlist.length); audio.play().catch(() => { }); }
                if (cmd === 'loadPlaylist') { playlist = data.playlist || []; if (typeof data.currentTrack === 'number') current = data.currentTrack; loadTrack(current); }
                if (cmd === 'setVolume') { audio.volume = data.volume; }
                sendState();
            }
        }, false);

        audio.addEventListener('play', sendState);
        audio.addEventListener('pause', sendState);
        audio.addEventListener('ended', () => { sendState(); });

        btnPlay.addEventListener('click', () => {
            if (audio.paused) audio.play().catch(() => { }); else audio.pause();
        });
        btnPrev.addEventListener('click', () => {
            loadTrack((current - 1 + playlist.length) % playlist.length);
            audio.play().catch(() => { });
        });
        btnNext.addEventListener('click', () => {
            loadTrack((current + 1) % playlist.length);
            audio.play().catch(() => { });
        });
        vol.addEventListener('input', (e) => { audio.volume = e.target.value / 100; sendState(); });

        // Inform opener when window is about to be closed
        window.addEventListener('beforeunload', () => {
            if (window.opener && !window.opener.closed) window.opener.postMessage({ type: 'popup-closed' }, '*');
        });
    </script>
</body>

</html>